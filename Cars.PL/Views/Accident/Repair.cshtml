@{
    ViewData["Title"] = "Accident Page";
}
@{
    Layout = "_Layout";
}
@inject UserManager<AppUser> userManager
@inject IAppUserService userService
@model List<Accident>
<link rel="stylesheet" href="~/css/Repair.css" />
<link rel="stylesheet" href="~/css/ViewBag.css" />
<script src="~/js/ViewBag.js"></script>



@if (ViewBag.Success != null)
{
    <div class="toast-alert success-toast">
        <span>@ViewBag.Success</span>
        <button class="close-btn">&times;</button>
    </div>
}

@if (ViewBag.Error != null)
{
    <div class="toast-alert error-toast">
        <span>@ViewBag.Error</span>
        <button class="close-btn">&times;</button>
    </div>
}

<section class="hero-wrap hero-wrap-2 js-fullheight" style="background-image: url('/images/bg_3.jpg');" data-stellar-background-ratio="0.5">
    <div class="overlay"></div>
    <div class="container">
        <div class="row no-gutters slider-text js-fullheight align-items-end justify-content-start">
            <div class="col-md-9 ftco-animate pb-5">
                <p class="breadcrumbs">
                    <span class="mr-2">
                        <a href="/">Home <i class="ion-ios-arrow-forward"></i></a>
                    </span> 
                    <span>Repairing <i class="ion-ios-arrow-forward"></i></span>
                </p>
                <h1 class="mb-3 bread">Repairing</h1>
            </div>
        </div>
    </div>
</section>

@if (User.IsInRole("User") || User.IsInRole("Admin"))
{
    <form asp-controller="Accident" asp-action="Create" method="get">
        <button type="submit" class="add-accident-btn">
            <i class="fa fa-plus"></i> Add An Accident
        </button>
    </form>
}

@if (Model == null || Model.Count == 0)
{
    <div class="no-accidents-message">
        <h2>No Accidents Available</h2>
        <p>There are currently no accidents available right now.</p>
    </div>
}
else
{
    <div class="accidents-container">
        @foreach (var accident in Model)
        {
            var user = await userService.GetById(accident.UserId);
            <div class="accident-card">
                <!-- Accident Image -->
               <div class="accident-image" style="background-image: url('/Files/@accident.AccidentImagePath');"></div>


                <!-- Accident Content -->
                <div class="accident-content">
                    <h2 class="accident-location">@accident.Location</h2>
                    <div class="info-row">
                            <span class="info-label">User:</span>
                            <span class="info-value description-value">@user.FullName</span>
                        </div>
                    <div class="info-row">
                            <span class="info-label">Car:</span>
                            <span class="info-value description-value">@accident.Car?.Brand - @accident.Car?.Model - @accident.Car?.Year</span>
                        </div>
                    <div class="accident-info">
                        <div class="info-row">
                            <span class="info-label">Date:</span>
                            <span class="info-value date-value">@accident.AccidentDate.ToString("MMM dd, yyyy")</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Description:</span>
                            <span class="info-value description-value">@accident.Description</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value description-value">@accident.Status</span>
                        </div>
                    </div>

                    <div class="action-buttons">
                        @if (User.IsInRole("Mechanic") && User.Identity.IsAuthenticated && accident.Status == "Pending")
                        {
                            <div class="button-row">
                                <form asp-controller="Offer" asp-action="CreateView" method="get">
                                    <button type="submit" name="AccidentId" value="@accident.AccidentId" class="btn-primary">
                                        <i class="fa fa-wrench"></i> Send Offer
                                    </button>
                                </form>
                            </div>
                        }
                        
                        @if (User.IsInRole("User") && User.Identity.IsAuthenticated && userManager.GetUserId(User) == accident.UserId)
                        {
                            <div class="button-row">
                                <form asp-controller="Accident" asp-action="EditView" method="get">
                                    <input type="hidden" name="accidentId" value="@accident.AccidentId" />
                                    <button type="submit" class="btn-primary">
                                        <i class="fa fa-edit"></i> Edit
                                    </button>
                                </form>
                                <form asp-controller="Accident" asp-action="DeleteView" method="get">
                                    <input type="hidden" name="accidentId" value="@accident.AccidentId" />
                                    <button type="submit" class="btn-secondary">
                                        <i class="fa fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        }
                        
                        @if (!User.Identity.IsAuthenticated)
                        {
                            <div class="button-row">
                                <form asp-controller="Account" asp-action="LoginView" method="post">
                                    <button type="submit" class="btn-secondary">
                                        <i class="fa fa-sign-in"></i> Login To Send Offer
                                    </button>
                                </form>
                            </div>
                        }

                        <form asp-controller="Accident" asp-action="Offers" method="get">
                            <input type="hidden" name="CarId" value="@accident.carId" />
                            <button type="submit" name="accidentId" value="@accident.AccidentId" class="btn-offers">
                                <i class="fa fa-list"></i> View Offers
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
}